{"version":3,"names":["resolveInternalLinks","require","fs","path","os","describe","testDir","outputBase","beforeEach","join","tmpdir","Date","now","ensureDir","afterEach","remove","test","sectionDir","page1Path","page2Path","writeFile","pageIdMap","isDir","internalLinks","id","href","text","content","readFile","expect","toBe","pageId","encodedId","encodeURIComponent","targetSectionDir","pagePath","not","toContain"],"sources":["linkResolver.test.js"],"sourcesContent":["const { resolveInternalLinks } = require('../src/linkResolver');\nconst fs = require('fs-extra');\nconst path = require('path');\nconst os = require('os');\n\ndescribe('Link Resolver - resolveInternalLinks', () => {\n    let testDir;\n    let outputBase;\n\n    beforeEach(async () => {\n        // Create temporary directory for testing\n        testDir = path.join(os.tmpdir(), `onenote-test-${Date.now()}`);\n        outputBase = path.join(testDir, 'notebook');\n        await fs.ensureDir(outputBase);\n    });\n\n    afterEach(async () => {\n        // Cleanup\n        await fs.remove(testDir);\n    });\n\n    describe('Standard ID Matching', () => {\n        test('resolves links with exact ID match', async () => {\n            const sectionDir = path.join(outputBase, 'Section1');\n            await fs.ensureDir(sectionDir);\n            const page1Path = path.join(sectionDir, 'Page1.md');\n            const page2Path = path.join(sectionDir, 'Page2.md');\n\n            await fs.writeFile(page1Path, '[[Target Page]]<!-- onenote-link:link_0 -->');\n            await fs.writeFile(page2Path, 'Target content');\n\n            const pageIdMap = {\n                '{page-1-id}': {\n                    path: page1Path,\n                    isDir: false,\n                    internalLinks: [{\n                        id: 'link_0',\n                        href: 'onenote:page-id={page-2-id}',\n                        text: 'Target Page'\n                    }]\n                },\n                '{page-2-id}': {\n                    path: page2Path,\n                    isDir: false,\n                    internalLinks: []\n                }\n            };\n\n            await resolveInternalLinks(pageIdMap, outputBase);\n\n            const content = await fs.readFile(page1Path, 'utf8');\n            expect(content).toBe('[[Section1/Page2|Target Page]]');\n        });\n\n        test('resolves links with encoded IDs', async () => {\n            const sectionDir = path.join(outputBase, 'Section1');\n            await fs.ensureDir(sectionDir);\n            const page1Path = path.join(sectionDir, 'Page1.md');\n            const page2Path = path.join(sectionDir, 'Page2.md');\n\n            await fs.writeFile(page1Path, '[[Link]]<!-- onenote-link:link_0 -->');\n            await fs.writeFile(page2Path, 'Content');\n\n            const pageId = '{abc-123}';\n            const encodedId = encodeURIComponent(pageId);\n\n            const pageIdMap = {\n                '{source-id}': {\n                    path: page1Path,\n                    isDir: false,\n                    internalLinks: [{\n                        id: 'link_0',\n                        href: `onenote:page-id=${encodedId}`,\n                        text: 'Link'\n                    }]\n                },\n                [pageId]: {\n                    path: page2Path,\n                    isDir: false,\n                    internalLinks: []\n                }\n            };\n\n            await resolveInternalLinks(pageIdMap, outputBase);\n\n            const content = await fs.readFile(page1Path, 'utf8');\n            expect(content).toBe('[[Section1/Page2|Link]]');\n        });\n    });\n\n    describe('Fuzzy ID Matching', () => {\n        test('matches IDs with braces and suffixes stripped', async () => {\n            const sectionDir = path.join(outputBase, 'Section1');\n            await fs.ensureDir(sectionDir);\n            const page1Path = path.join(sectionDir, 'Page1.md');\n            const page2Path = path.join(sectionDir, 'Page2.md');\n\n            await fs.writeFile(page1Path, '[[Target]]<!-- onenote-link:link_0 -->');\n            await fs.writeFile(page2Path, 'Content');\n\n            const pageIdMap = {\n                '{source-id}': {\n                    path: page1Path,\n                    isDir: false,\n                    internalLinks: [{\n                        id: 'link_0',\n                        // Link contains UUID without braces\n                        href: 'onenote:page-id=abc-123-456-789-012345678901',\n                        text: 'Target'\n                    }]\n                },\n                // DOM ID has braces and suffix\n                '{abc-123-456-789-012345678901}{1}': {\n                    path: page2Path,\n                    isDir: false,\n                    internalLinks: []\n                }\n            };\n\n            await resolveInternalLinks(pageIdMap, outputBase);\n\n            const content = await fs.readFile(page1Path, 'utf8');\n            expect(content).toBe('[[Section1/Page2|Target]]');\n        });\n    });\n\n    describe('Directory Links', () => {\n        test('resolves links to section directories', async () => {\n            const sectionDir = path.join(outputBase, 'Section1');\n            const targetSectionDir = path.join(outputBase, 'Section2');\n            await fs.ensureDir(sectionDir);\n            await fs.ensureDir(targetSectionDir);\n            const pagePath = path.join(sectionDir, 'Page1.md');\n\n            await fs.writeFile(pagePath, '[[Section Link]]<!-- onenote-link:link_0 -->');\n\n            const pageIdMap = {\n                '{source-id}': {\n                    path: pagePath,\n                    isDir: false,\n                    internalLinks: [{\n                        id: 'link_0',\n                        href: 'onenote:section-id={section-2-id}',\n                        text: 'Section Link'\n                    }]\n                },\n                '{section-2-id}': {\n                    path: targetSectionDir,\n                    isDir: true,\n                    internalLinks: []\n                }\n            };\n\n            await resolveInternalLinks(pageIdMap, outputBase);\n\n            const content = await fs.readFile(pagePath, 'utf8');\n            // Should not have .md extension for directories\n            expect(content).toBe('[[Section2|Section Link]]');\n        });\n    });\n\n    describe('Comment Cleanup', () => {\n        test('removes unresolved link comments', async () => {\n            const sectionDir = path.join(outputBase, 'Section1');\n            await fs.ensureDir(sectionDir);\n            const pagePath = path.join(sectionDir, 'Page1.md');\n\n            await fs.writeFile(pagePath, 'Some text [[Broken Link]]<!-- onenote-link:link_0 --> more text');\n\n            const pageIdMap = {\n                '{source-id}': {\n                    path: pagePath,\n                    isDir: false,\n                    internalLinks: [{\n                        id: 'link_0',\n                        href: 'onenote:page-id={nonexistent}',\n                        text: 'Broken Link'\n                    }]\n                }\n            };\n\n            await resolveInternalLinks(pageIdMap, outputBase);\n\n            const content = await fs.readFile(pagePath, 'utf8');\n            expect(content).toBe('Some text [[Broken Link]] more text');\n            expect(content).not.toContain('<!-- onenote-link:');\n        });\n\n        test('removes multiple comment markers', async () => {\n            const sectionDir = path.join(outputBase, 'Section1');\n            await fs.ensureDir(sectionDir);\n            const pagePath = path.join(sectionDir, 'Page1.md');\n\n            await fs.writeFile(pagePath, '[[Link1]]<!-- onenote-link:link_0 --> and [[Link2]]<!-- onenote-link:link_1 -->');\n\n            const pageIdMap = {\n                '{source-id}': {\n                    path: pagePath,\n                    isDir: false,\n                    internalLinks: [\n                        { id: 'link_0', href: 'onenote:page-id={missing1}', text: 'Link1' },\n                        { id: 'link_1', href: 'onenote:page-id={missing2}', text: 'Link2' }\n                    ]\n                }\n            };\n\n            await resolveInternalLinks(pageIdMap, outputBase);\n\n            const content = await fs.readFile(pagePath, 'utf8');\n            expect(content).toBe('[[Link1]] and [[Link2]]');\n        });\n    });\n\n    describe('Self-referencing Links', () => {\n        test('ignores links from a page to itself', async () => {\n            const sectionDir = path.join(outputBase, 'Section1');\n            await fs.ensureDir(sectionDir);\n            const pagePath = path.join(sectionDir, 'Page1.md');\n\n            await fs.writeFile(pagePath, '[[Self Reference]]<!-- onenote-link:link_0 -->');\n\n            const pageIdMap = {\n                '{page-1-id}': {\n                    path: pagePath,\n                    isDir: false,\n                    internalLinks: [{\n                        id: 'link_0',\n                        href: 'onenote:page-id={page-1-id}',\n                        text: 'Self Reference'\n                    }]\n                }\n            };\n\n            await resolveInternalLinks(pageIdMap, outputBase);\n\n            const content = await fs.readFile(pagePath, 'utf8');\n            // Should just remove the comment, not replace the link\n            expect(content).toBe('[[Self Reference]]');\n        });\n    });\n});\n"],"mappings":"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","ignoreList":[]}