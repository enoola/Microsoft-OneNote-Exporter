{"version":3,"names":["fs","require","path","resolveInternalLinks","pageIdMap","outputBase","pageId","info","Object","entries","isDir","content","readFile","modified","link","internalLinks","targetId","keys","find","id","href","includes","encodeURIComponent","cleanId","replace","split","length","targetInfo","relPath","relative","cleanPath","placeholderRegex","RegExp","text","writeFile","module","exports"],"sources":["linkResolver.js"],"sourcesContent":["const fs = require('fs-extra');\nconst path = require('path');\n\n/**\n * Resolves internal OneNote links to Obsidian wikilinks\n * @param {Object} pageIdMap - Map of page IDs to their metadata\n * @param {string} outputBase - Base output directory (notebook root)\n * @returns {Promise<void>}\n */\nasync function resolveInternalLinks(pageIdMap, outputBase) {\n    for (const [pageId, info] of Object.entries(pageIdMap)) {\n        if (info.isDir) continue;\n\n        let content = await fs.readFile(info.path, 'utf8');\n        let modified = false;\n\n        for (const link of info.internalLinks || []) {\n            // Try to find the target item (page, section, or group) in our map\n            const targetId = Object.keys(pageIdMap).find(id => {\n                // 1. Standard relaxed match (handles encoded IDs)\n                if (link.href.includes(id) || link.href.includes(encodeURIComponent(id))) {\n                    return true;\n                }\n\n                // 2. Fuzzy match: OneNote IDs in DOM often look like \"{UUID}{1}\", \n                // while links might use \"UUID\" or \"section-id={UUID}\".\n                // We strip braces and suffixes to get the core UUID.\n                // Example: \"{123-456}{1}\" -> \"123-456\"\n                const cleanId = id.replace(/^\\{/, '').split('}')[0];\n\n                // Only perform fuzzy string match if we have a valid-looking UUID (min length)\n                if (cleanId.length > 20 && link.href.includes(cleanId)) {\n                    return true;\n                }\n\n                return false;\n            });\n\n            if (targetId && targetId !== pageId) {\n                const targetInfo = pageIdMap[targetId];\n\n                // Use path relative to the Output Base (Notebook Root)\n                // This creates \"Absolute in Vault\" style links: [[Group/Section/Page]]\n                let relPath = path.relative(outputBase, targetInfo.path);\n\n                // Avoid .md extension for Wikilinks to files\n                const cleanPath = targetInfo.isDir ? relPath : relPath.replace(/\\.md$/, '');\n\n                // IMPORTANT: Use a non-capturing group for the bracketed text because \n                // Turndown might have escaped characters (like _ to \\_) inside it.\n                // We target the unique onenote-link ID instead.\n                const placeholderRegex = new RegExp(`\\\\[\\\\[.*?\\\\]\\\\]<!-- onenote-link:${link.id} -->`, 'g');\n\n                content = content.replace(placeholderRegex, `[[${cleanPath}|${link.text}]]`);\n                modified = true;\n            }\n        }\n\n        // Cleanup: Remove any remaining onenote-link comments (for links that weren't resolved)\n        // Also remove the comments for successfully resolved links if the regex above didn't catch them all (it should have replaced the whole block)\n        // But specifically for UNRESOLVED links, we want to keep the text but remove the comment.\n        // The structure for unresolved is likely: [[Link Text]]<!-- onenote-link:id -->\n        // We just want to remove the comment part globally.\n        if (content.includes('<!-- onenote-link:')) {\n            content = content.replace(/<!-- onenote-link:.*? -->/g, '');\n            modified = true;\n        }\n\n        if (modified) {\n            await fs.writeFile(info.path, content);\n        }\n    }\n}\n\nmodule.exports = { resolveInternalLinks };\n"],"mappings":"AAAA,MAAMA,EAAE,GAAGC,OAAO,CAAC,UAAU,CAAC;AAC9B,MAAMC,IAAI,GAAGD,OAAO,CAAC,MAAM,CAAC;;AAE5B;AACA;AACA;AACA;AACA;AACA;AACA,eAAeE,oBAAoBA,CAACC,SAAS,EAAEC,UAAU,EAAE;EACvD,KAAK,MAAM,CAACC,MAAM,EAAEC,IAAI,CAAC,IAAIC,MAAM,CAACC,OAAO,CAACL,SAAS,CAAC,EAAE;IACpD,IAAIG,IAAI,CAACG,KAAK,EAAE;IAEhB,IAAIC,OAAO,GAAG,MAAMX,EAAE,CAACY,QAAQ,CAACL,IAAI,CAACL,IAAI,EAAE,MAAM,CAAC;IAClD,IAAIW,QAAQ,GAAG,KAAK;IAEpB,KAAK,MAAMC,IAAI,IAAIP,IAAI,CAACQ,aAAa,IAAI,EAAE,EAAE;MACzC;MACA,MAAMC,QAAQ,GAAGR,MAAM,CAACS,IAAI,CAACb,SAAS,CAAC,CAACc,IAAI,CAACC,EAAE,IAAI;QAC/C;QACA,IAAIL,IAAI,CAACM,IAAI,CAACC,QAAQ,CAACF,EAAE,CAAC,IAAIL,IAAI,CAACM,IAAI,CAACC,QAAQ,CAACC,kBAAkB,CAACH,EAAE,CAAC,CAAC,EAAE;UACtE,OAAO,IAAI;QACf;;QAEA;QACA;QACA;QACA;QACA,MAAMI,OAAO,GAAGJ,EAAE,CAACK,OAAO,CAAC,KAAK,EAAE,EAAE,CAAC,CAACC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;;QAEnD;QACA,IAAIF,OAAO,CAACG,MAAM,GAAG,EAAE,IAAIZ,IAAI,CAACM,IAAI,CAACC,QAAQ,CAACE,OAAO,CAAC,EAAE;UACpD,OAAO,IAAI;QACf;QAEA,OAAO,KAAK;MAChB,CAAC,CAAC;MAEF,IAAIP,QAAQ,IAAIA,QAAQ,KAAKV,MAAM,EAAE;QACjC,MAAMqB,UAAU,GAAGvB,SAAS,CAACY,QAAQ,CAAC;;QAEtC;QACA;QACA,IAAIY,OAAO,GAAG1B,IAAI,CAAC2B,QAAQ,CAACxB,UAAU,EAAEsB,UAAU,CAACzB,IAAI,CAAC;;QAExD;QACA,MAAM4B,SAAS,GAAGH,UAAU,CAACjB,KAAK,GAAGkB,OAAO,GAAGA,OAAO,CAACJ,OAAO,CAAC,OAAO,EAAE,EAAE,CAAC;;QAE3E;QACA;QACA;QACA,MAAMO,gBAAgB,GAAG,IAAIC,MAAM,CAAC,oCAAoClB,IAAI,CAACK,EAAE,MAAM,EAAE,GAAG,CAAC;QAE3FR,OAAO,GAAGA,OAAO,CAACa,OAAO,CAACO,gBAAgB,EAAE,KAAKD,SAAS,IAAIhB,IAAI,CAACmB,IAAI,IAAI,CAAC;QAC5EpB,QAAQ,GAAG,IAAI;MACnB;IACJ;;IAEA;IACA;IACA;IACA;IACA;IACA,IAAIF,OAAO,CAACU,QAAQ,CAAC,oBAAoB,CAAC,EAAE;MACxCV,OAAO,GAAGA,OAAO,CAACa,OAAO,CAAC,4BAA4B,EAAE,EAAE,CAAC;MAC3DX,QAAQ,GAAG,IAAI;IACnB;IAEA,IAAIA,QAAQ,EAAE;MACV,MAAMb,EAAE,CAACkC,SAAS,CAAC3B,IAAI,CAACL,IAAI,EAAES,OAAO,CAAC;IAC1C;EACJ;AACJ;AAEAwB,MAAM,CAACC,OAAO,GAAG;EAAEjC;AAAqB,CAAC","ignoreList":[]}