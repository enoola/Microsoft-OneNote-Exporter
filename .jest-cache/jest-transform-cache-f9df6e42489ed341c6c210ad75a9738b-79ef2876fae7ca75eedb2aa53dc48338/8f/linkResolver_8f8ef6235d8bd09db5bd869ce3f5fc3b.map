{"version":3,"names":["fs","require","path","resolveInternalLinks","pageIdMap","outputBase","pageId","info","Object","entries","isDir","content","readFile","modified","link","internalLinks","targetId","keys","find","id","href","includes","encodeURIComponent","cleanId","replace","split","length","parts","hierarchy","decodeURIComponent","fragment","fullTargetPath","startsWith","toLowerCase","pageName","relToVault","relative","endsWith","e","targetInfo","relPath","cleanPath","placeholderRegex","RegExp","text","writeFile","module","exports"],"sources":["linkResolver.js"],"sourcesContent":["const fs = require('fs-extra');\nconst path = require('path');\n\n/**\n * Resolves internal OneNote links to Obsidian wikilinks\n * @param {Object} pageIdMap - Map of page IDs to their metadata\n * @param {string} outputBase - Base output directory (notebook root)\n * @returns {Promise<void>}\n */\nasync function resolveInternalLinks(pageIdMap, outputBase) {\n    for (const [pageId, info] of Object.entries(pageIdMap)) {\n        if (info.isDir) continue;\n\n        let content = await fs.readFile(info.path, 'utf8');\n        let modified = false;\n\n        for (const link of info.internalLinks || []) {\n            // Try to find the target item (page, section, or group) in our map\n            let targetId = Object.keys(pageIdMap).find(id => {\n                // Ignore empty or invalid IDs\n                if (!id || id === 'undefined' || id === 'null') return false;\n\n                // 1. Standard relaxed match (handles encoded IDs)\n                if (link.href.includes(id) || link.href.includes(encodeURIComponent(id))) {\n                    return true;\n                }\n\n                // 2. Fuzzy match: OneNote IDs in DOM often look like \"{UUID}{1}\", \n                // while links might use \"UUID\" or \"section-id={UUID}\".\n                // We strip braces and suffixes to get the core UUID.\n                // Example: \"{123-456}{1}\" -> \"123-456\"\n                const cleanId = id.replace(/^\\{/, '').split('}')[0];\n\n                // Only perform fuzzy string match if we have a valid-looking UUID (min length)\n                if (cleanId.length > 20 && link.href.includes(cleanId)) {\n                    return true;\n                }\n\n                return false;\n            });\n\n            // 3. Fallback: Path-based matching for onenote: links (User suggestion)\n            // Example page: onenote:Group\\Section.one#Page&...\n            // Example section: onenote:Section.one#section-id={...}&end\n            if (!targetId && link.href.includes('onenote:')) {\n                const parts = link.href.split('#');\n                if (parts.length > 1) {\n                    try {\n                        const hierarchy = decodeURIComponent(parts[0].replace('onenote:', '').replace(/\\\\/g, '/')).replace(/\\.one$/, '');\n                        const fragment = decodeURIComponent(parts[1]);\n\n                        let fullTargetPath;\n                        if (fragment.startsWith('section-id=')) {\n                            // Link to a section/folder\n                            fullTargetPath = hierarchy.toLowerCase();\n                        } else {\n                            // Link to a page\n                            const pageName = fragment.split('&')[0];\n                            fullTargetPath = hierarchy ? `${hierarchy}/${pageName}`.toLowerCase() : pageName.toLowerCase();\n                        }\n\n                        targetId = Object.keys(pageIdMap).find(id => {\n                            const info = pageIdMap[id];\n                            const relToVault = path.relative(outputBase, info.path).replace(/\\.md$/, '').toLowerCase();\n                            // Match either the full path or just the end (if sections are deeply nested)\n                            return relToVault === fullTargetPath || relToVault.endsWith('/' + fullTargetPath);\n                        });\n                    } catch (e) {\n                        // Ignore parsing errors\n                    }\n                }\n            }\n\n\n\n            if (targetId && targetId !== pageId) {\n                const targetInfo = pageIdMap[targetId];\n\n                // Use path relative to the Output Base (Notebook Root)\n                // This creates \"Absolute in Vault\" style links: [[Group/Section/Page]]\n                let relPath = path.relative(outputBase, targetInfo.path);\n\n                // Avoid .md extension for Wikilinks to files\n                const cleanPath = targetInfo.isDir ? relPath : relPath.replace(/\\.md$/, '');\n\n                // IMPORTANT: Use a non-capturing group for the bracketed text because \n                // Turndown might have escaped characters (like _ to \\_) inside it.\n                // We target the unique onenote-link ID instead.\n                const placeholderRegex = new RegExp(`\\\\[\\\\[.*?\\\\]\\\\]<!-- onenote-link:${link.id} -->`, 'g');\n\n                content = content.replace(placeholderRegex, `[[${cleanPath}|${link.text}]]`);\n                modified = true;\n            }\n        }\n\n        // Cleanup: Remove any remaining onenote-link comments (for links that weren't resolved)\n        // Also remove the comments for successfully resolved links if the regex above didn't catch them all (it should have replaced the whole block)\n        // But specifically for UNRESOLVED links, we want to keep the text but remove the comment.\n        // The structure for unresolved is likely: [[Link Text]]<!-- onenote-link:id -->\n        // We just want to remove the comment part globally.\n        if (content.includes('<!-- onenote-link:')) {\n            content = content.replace(/<!-- onenote-link:.*? -->/g, '');\n            modified = true;\n        }\n\n        if (modified) {\n            await fs.writeFile(info.path, content);\n        }\n    }\n}\n\nmodule.exports = { resolveInternalLinks };\n"],"mappings":"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","ignoreList":[]}